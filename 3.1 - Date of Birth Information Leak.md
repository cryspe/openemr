# 3.1.	Date of Birth Information Leak
Analysis of the self-registration function of the patient portal in OpenEMR began with an overview of the workflow.  The patient initiates the self-registration workflow on the primary patient portal page by clicking the “Register” link. They then provide their name, date of birth, and email, submitting these items to the server.  The server checks for duplication and returns the demographics registration if none exists.  Next, the patient provides their demographic information, requiring their address and gender, optionally allowing them to input their social security number, phone, and emergency contact information.  This screen also allows them to send the admin a comment and specify communication preferences. Upon submission and validation, they are required to input their insurance information.  Following a successful registration, they receive a notice that the account will be created, and the generated credentials are sent to the email they specified.

## 3.1.1.	Vulnerability Discovery
The process of a duplication check can be concerning to patient privacy.  Specialists who focus on sensitive areas such as HIV, cancer, or reproductive medicine can cause sensitivity in even knowing that someone is a practice patient (Adler S., 2022)[^Adler].  This warranted a closer look into the code to review the procedures used to verify the duplicates.

The duplication check process occurs within the “/portal/account/account.lib.php” file under the “isNew” function.  This function looks for three combinations that represent a likely duplicate.  First, it checks the email and date of birth combination.  If no match is found, it checks the last name, first name, date of birth, and email.  If no match is found, it checks the last name, first name, and date of birth.  The “LIKE” operator is used with each parameter in all these queries, allowing partial matches by using a “%” in the field.  The client-side JavaScript does check the date submission for a valid date. The check against an email is shown below:
```php
        /portal/account/account.lib.php  
        48: $sql = "select pid from patient_data " .  
        49:  "Where (patient_data.email LIKE ? OR patient_data.email_direct LIKE ?) " .  
        50:  "And patient_data.DOB LIKE ? order by date limit 0,1";
```
This combination of checks allows the verification of date of birth and email combination, and with enough checks, even obtaining an unknown date of birth from a valid email.  Similar checks for first and last name allow retrieval of the date of birth by patient name.

MITRE identifies the act of not setting a proper limit to the number or frequency of an interaction with an actor as Improper Control of Interaction Frequency (CWE-799).  The ability to use only a portion of the name, email or date of birth is identified by MITRE as a Partial String Comparison (CWE-187).  The resulting ability to obtain the date of birth from an email or name is recognized by MITRE as an Exposure of Private Personal Information to an Unauthorized Actor (CWE-359).  

## 3.1.2.	Exploitation
To develop an exploit surrounding the date of birth disclosure, PowerShell 7 was used for its ease of development, troubleshooting, and built-in web request framework.  The exploit’s goal is to provide the date of birth of a known individual.  Since the server-side code utilizes the “LIKE” operator on request, functionality was added to the exploit to search by a partial name or email.

The exploit begins by collecting the patient’s email, first name, and last name.  If only the email or name is known, the program allows for a blank field to be returned.  Next, a server request is made to establish a session and store the session variable for reuse in future web requests.  Since the code allows the “LIKE” operator on the date of birth field, the code performs an initial check with a “%” date of birth to verify that the given name or email is a patient.  Once verified, the code begins to identify the date of birth. Again, using the “LIKE” operator, the code breaks the date into a century loop, decade loop, year loop, month loop, and day loop.  Using this method, the maximum number of calls needed to identify a birthdate is five values for the century, ten values for the decade, ten values for the year, twelve values for the month, and thirty-one values for the day, totaling sixty-eight possible values, which on average took seven seconds but would be dependent on the internet connection and server specifications.

The complete POC code is provided in [Appendix A](https://github.com/cryspe/openemr/blob/main/Appendix%20A%20-%20Birthday%20Finder.ps1).

## 3.1.3.	Mitigation Advice
To mitigate this vulnerability, the process of self-registration should not provide any information to the requestor of an existing patient.  In communications with the project owner, the recommendation was provided to add an email verification check and captcha code following the initial submission of name and email.  This procedure is outlined in OWASP WSTG-IDNT-02 testing process.  This will block any automated script deployment and require the submitter to have access to the patient’s registered email to proceed further.  A “Welcome” email or a “You already have an account” email can be submitted depending on the patient’s enrollment status to provide the current functionality.

The recommendations to remove the LIKE operator from the date of birth field, the patient’s name fields, and the email field to prevent further abuse of the SQL query were also provided.

## 3.1.4.	Scoring and Disclosure
This vulnerability is usable from the public internet and requires a low complexity of code to exploit, and has no privileges, and no user interaction.  The impact of identifying a patient’s date of birth and verifying that they are a patient of the practice rates a high confidentiality impact. These factors contribute to a base score of 7.5.  Since a reliable exploit exists and has been confirmed by the project owner, the temporal score is 7.3.  Finally, Environmental Score components follow the base score components and contribute to a score of 7.3. This calculates to a CVVS v3.1 score of 7.3.

The vulnerability, exploit, and CVVS calculations were provided to the project owners via secure email, who verified the receipt and began work on a patch to alleviate the issue.  Following the patch publication, the source code for the exploit was posted on GitHub, and a CVE was published to identify the vulnerability publicly and promote patching. The CVE ID issued for this vulnerability is CVE-2022-XXXXX.

[^Adler]: Adler, S. (2022, January 28) What Is Considered PHI Under HIPAA. HIPPA Journal. Retrieved from https://www.hipaajournal.com/considered-phi-hipaa/
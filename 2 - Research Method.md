# Research Method
Dynamic code analysis is needed to identify vulnerabilities beyond what a static code analysis can offer.  Running the application, interacting with the controls, and following the corresponding code calls allows the discovery of potential sources of vulnerability within the code.

Due to limitations surrounding the accessibility of the code and function documentation, an open-sourced EMR was chosen for this project.  OpenEMR (https://www.open-emr.org/) was identified as the most promising open-source EMR by Healthcare Informatics Research in 2019 (Saptarshi, 2019)[^Saptarshi].  OpenEMR is a well-adopted, maintained, fully open-source, and free-to-use application, making it the best representative for code analysis and vulnerability discovery.

The vulnerabilities discovered were prioritized by their Common Vulnerability Scoring System (CVSS) score calculated using the available tool https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator. It was used to provide a prioritized list of software review areas in EMR development.  

## 2.1.  Test Bench Setup
The OpenEMR 6.0.0.0 source code was obtained from GitHub (https://github.com/openemr/openemr), and the latest security patch, 6.0.0.0 (3) (https://www.open-emr.org/wiki/index.php/OpenEMR_Patches), was applied to ensure all previously discovered vulnerabilities were patched.  The server setup involved creating a Debian (https://www.debian.org/) virtual machine to host the OpenEMR application and the underlying Maria DB (https://mariadb.org/) instance.  The software installation was performed according to the instructions on the OpenEMR site (https://www.open-emr.org/wiki/index.php/OpenEMR_6.0.0_Linux_Installation).  Since the application is a PHP web server, XDebug (https://xdebug.org/) was installed on the server to serve remote debugging to Visual Studio Code (https://code.visualstudio.com/). XDebug was removed during the final exploit analysis to ensure no identified vulnerabilities were being introduced through that software.

The application and server configuration followed the best practices outlined in the OpenEMR Securing OpenEMR wiki (https://www.open-emr.org/wiki/index.php/OpenEMR_Wiki_Home_Page#Security_.2F_Hardening).  This removed several highly privileged installation scripts and limited the option of file types that could be loaded within the application.

The debugging workstation utilized Visual Studio Code for its debugging capabilities and ease of setup.  The source code was pulled from GitHub and patched to the same version as the server for the debugging workstation. The PHP Debug extension (https://marketplace.visualstudio.com/items?itemName=xdebug.php-debug) was installed to enable debugging capabilities between the server and debugging workstation.  Google Chrome (https://www.google.com/chrome) and Microsoft Edge (https://www.microsoft.com/en-us/edge?r=1) browsers were used to interact with the servers, and Progress Telerik Fiddler Classic (https://www.telerik.com/fiddler/fiddler-classic) was used to decrypt, monitor, and edit the HTTP calls.

## 2.2.  Identifying the Severity of a Vulnerability
To identify the severity of a vulnerability, the industry-standard method at the time of this paper is the Common Vulnerability Scoring System v3.1 (CVSS) (https://first.org).  This scoring system prioritized the research to provide the highest impact on security.  Since the vulnerabilities will all be located within the same application, have an accompanying proof of concept, be reported to the vendor, and were withheld from public publishing before patch availability, only the attack vector and privilege are used to prioritize the components.   The attack vector and privilege values were taken from the specification document of CVSS v3.1 (https://www.first.org/cvss/specification-document).

## 2.3.  Segmenting Code by Purpose
An EMR contains four main components: administrative, clinical, practice management, and patient portal.  These four components were used to create a CVSS severity to prioritize the highest impact component of the application.  Given the time constraints of this project, only the highest impact component will be tested, but the remaining components are prioritized for future research opportunities.  Each component will be given a score by identifying the attack vector and privilege.

The administrative component provides the functionality to configure and control access.  This component should be exposed to only a small group of trusted individuals and should only be accessible through the local network.  This provides an Attack Vector value of .62 and a Privilege value of .27.  Utilizing the formula of the CVSS scoring system, these two values are multiplied together, resulting in a weight of .1674.

The clinical component provides the mechanism to document patient care. This component can be limited to the patient’s care team, who require the ability to document within the patient chart and should be accessible only through the local network.  This provides an Attack Vector value of .62 and a Privilege value of .44, resulting in a weight of .2816, a 62% increase over the administrative component.

The practice management component serves as the Customer Relationship Management (CRM) for a healthcare team. An expanded group of users require this privilege to perform scheduling, registration, and billing operations and should be accessible only through the local network.  This provides an Attack Vector value of .62 and a Privilege value of .44, resulting in a weight of .2816.  This shares the same weight with the clinical component, although it could be argued that the increased number of individuals with login privilege contributes to a higher weight.

The patient portal component provides the patient with access to their healthcare information and can also feature scheduling and messaging functionality. The patient population would consist of the most extensive collection of accounts and would require access from outside the company network.  This provides an Attack Vector value of .85 and a Privileged value of .44, resulting in a weight of .374.  This represents a 123% increase over the weight of an administrative component and a 32% increase over the clinical and practice management weights.

The patient portal was chosen for the focus of this paper.  Given the number of accounts, a continued review would start with the practice management component, followed by the clinical and administrative component.

Additional security could be applied to proxy the login process through a single-sign-on provider for each employee-related component.  This would eliminate exposure of a vulnerability before the credentialed access. However, implementing a proxy to the patient portal would be significantly more difficult and costly.  The patient portal can provide additional exposure to a vulnerability before credentialed access.  This increases the privilege value from .44 to .85 and results in a weight of .7225, representing a 93% increase.

## 2.4.  Dynamic Code Review
Understanding the application’s intended functionality is crucial to identifying possible exposure points in the application.  By capturing the traffic to and from the application, the penetration tester can walk back through requests and determine the security used and how it was implemented.  Project Telerik Fiddler Classic (https://www.telerik.com/fiddler/fiddler-classic) provides the ability to capture and decrypt the HTTP/HTTPS traffic to and from the EMR application.  Filters were applied to limit the capture to the host running the EMR application.

Not all features will be enabled by default.  Edge cases can be obtained by referencing the administration guide, enabling features, and capturing the traffic when utilizing those features.  Exploration of the features available was performed by referencing the administration guide (https://www.open-emr.org/wiki/index.php/OpenEMR_Wiki_Home_Page).  The patient portal and self-registration features were enabled, and a patient was registered and performed a login to capture those workflows.

While enumerating the features, specific attention was taken to areas where a code vulnerability is most likely to exist.  The Open Web Application Security Project (OWASP) Top 10 (https://owasp.org/www-project-top-ten) defines an application's most likely vulnerability exposures.  Utilizing the listing from 2021, broken access control is ranked first and focuses on the authentication mechanisms within the application.  Cryptographic failure ranks second. The review of the fiddler data can highlight areas of the application missing encryption or utilizing weak encryption.  Injection ranks third and relates to how the application builds the queries for the back-end database.  Identifying where these queries take place, within the code directly or obscured behind an API, can assist in identifying targets.  To prioritize efforts for security analysts, working in a top-down order of the OWASP Top 10 can provide efficiency and ensure that a thorough review of each category is fully vetted.  This paper will primarily focus on broken access control, identifying other related categories within the code as they are discovered.

## 2.5.  Static code review
With the areas of code identified, a static review is necessary to understand how the security controls are implemented.  The security researcher follows the code line by line through the decision tree to look for a corresponding MITRE Common Weakness Enumeration (CWE) (https://cwe.mitre.org/).  The OWASP Top 10 provides a mapping between the category and the CWE to assist in identifying.  Thirty-four CWEs are mapped to the Broken Access category.  At this level, prioritization is less available.  Understanding the weaknesses and locating them within the code takes a thorough review.  This mapping often happens by discovering the defect and mapping back to the CWE that it closest resembles once it is understood.

Attention should be prioritized to areas of access control to understand how the safeguards are implemented and find workarounds to how they may be abused.  If the application safeguards the access to an API through a session variable, how is this session variable set?  Are there any application areas where the attacker can influence the value set to the variable? (CWE-285) Is there a way to bypass the authorization check by running the code unattended, such as loading a registration session but not completing it?  (CWE-425) For injection opportunities, security researchers should identify the parameters of a SQL command and follow them back through the code to determine where the variables are set.  Can these variables be influenced in unpredictable ways? (CWE-20).  These are only a few examples, but MITRE maintains example code for each CWE identified to assist in discovery and attribution.

## 2.6.  Turning a Weakness into A Vulnerability
To turn a weakness into a vulnerability, an exploit must be developed which can take advantage of the weakness.  While a weakness may exist in the code, such as a SQL injection vulnerability, the value to an attacker is nullified if there is no means to exploit the weakness.  The security researcher’s job does not stop with identifying the weakness. Still, it continues through the build of an exploit to verify the weakness and expose a vulnerability in the application’s security.  Exploitation typically involves creating a Proof of Concept (POC) script to verify the existence of the vulnerability and provide an example use of a malicious actor.  Scripting languages offer flexibility and ease of coding to create these POC applications quickly. Microsoft PowerShell v7.2 (https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell-on-windows?view=powershell-7.2) was used to develop the POC scripts for this vulnerability analysis.  Python is another excellent choice, but the author has more familiarity with the object-oriented coding of PowerShell.

The POC should be as straightforward and minimalistic as possible to reduce the complexity involved. An exploit will rarely require more than a command-line interaction.  The code should be well documented with comments to identify the calls used and walk the developer through exploitation.  It is important to remember to keep the end goal of relaying how an attacker can abuse the system to the developer and refrain from adding unnecessary logic that could confuse or detract from the focus of the vulnerability.

## 2.7. Disclosure
The goal of disclosure is to promote the awareness and patching of the vulnerability to exposed systems.  It is essential to work with the vendor during this process to ensure that the application users have a patch or mitigating control available to them to remedy the vulnerability.  By disclosing the vulnerability privately to the vendor and allowing an embargo time for the vendor to address the issue and ensure that the patch is sufficiently distributed through the affected systems, the security researcher can limit the unintended harm caused by an attacker using the exploit on an unpatched system.  For services as sensitive as an EMR, special care and coordination ensure that all reasonable measures are taken to give affected installations a chance to remedy the vulnerability.  Communication with the vendor on the discovered vulnerabilities and the expectations of public disclosure should be clear and part of the initial dialog.  Each vendor will have a preferred embargo time to develop and publish the patch.  The typical time in the industry for this embargo is between 90 and 120 days. Still, as referenced by FIRST, care should be taken to work with the vendor to set an acceptable embargo time when possible (Forum of Incident Response and Security Team [FIRST], 2021)[^FIRST].

Communications between the vendor and the security researcher should contain a minimum of the identified section of code where the vulnerability was found, the CVSS rating of the vulnerability, and a POC to replicate the exploitation of the weakness.  Typically, the CVSS score will lower once the vendor addresses the issue since a patch is available.  This adjustment is made to the temporal metrics under the remediation level factor.

Vulnerabilities discovered within this research were disclosed to the project owners via secure email with a script to perform verification of each exploit. The developers acknowledged receipt, and the publication of this paper was delayed, providing ample time for the project owners to address the issues.  The exploitation code was published on GitHub after approval from the project owners and verification that an update was available.

[^FIRST]: Forum of Incident Response and Security Team (FIRST) (2021) Guidelines and Practices for Multi-Party Vulnerability Coordination and Disclosure. Retrieved from https://www.first.org/global/sigs/vulnerability-coordination/multiparty/guidelines-v1.1

[^Saptarshi]: Saptarshi Purkayastha, Roshini Allam, Pallavi Maity, Judy W. Gichoya (2019, April) Comparison of Open-Source Electronic Health Record Systems Based on Functional and User Performance Criteria. *Healthcare Informatics Research, April*;25(2):89-98, https://doi.org/10.4258/hir.2019.25.2.89